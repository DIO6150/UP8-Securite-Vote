import paillier
import socket
import chiffrement
import queue
import threading
server_cle_public = 2

def send(msg):
	if(type(msg)==int):
		msg_bytes = msg.to_bytes(4, 'big')
	else:
		msg_bytes = msg.encode('ASCII')
	msg_chiffre = chiffrement.rsa(server_cle_public,msg_bytes)
	size = len(msg_chiffre).to_bytes(4, 'big')
	client.sendall(size + msg_chiffre)

def listen():
	while(True):
		size_bytes = client.recv(4)
		if(len(size_bytes) != 0):
			msg_size = int.from_bytes(size_bytes, 'big')
			msg_chiffre = client.recv(msg_size)
			msg_dechiffre = chiffrement.rsa(cle_private, msg_chiffre).decode('ASCII')
			responses.put(msg_dechiffre) # queue est thread safe


client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

cle_public=paillier.generate_prime(2048)
cle_private=paillier.generate_prime(2048)
cle_paillier=((488515340344993323917400756787503527780909122454065787163751288532297676803107375385866015987133449103981488927270976699062805987617863144700011815391678529413502794773413320936327447220259453208979468730705087037372158854880384467715781160177138614969603045726997922071047500857340806069189158709215635242729553585563761095095693642463816510619482785576960370694079609031048841621266899403927593436588462868421606761514858887598967480638609582457970361111211772638047117931968397256718682318361446640249420151472348344475234992860568605515848173388433164886037247789277494331767915462657449349925652212607570624493475211996671539655630847952482082931169256673959722447906961137772769106520675213624107997020491140401081707013651452805784438912008371871292005235039393625546182172005376371830433584508857295200550745364042746584890082987140571777579583760220247338475203256004042686084234963990844108097426666122749212726977199804886411777903635953200887595772956134015363575902106063850623363111056377991700008363975884987285249916838232464233798661021425142104449949071867884145860557276445771208024856598823165127864476768837421434282022073239908948629169608868277543003648167347477692699052812109574298965145832053856742279399751, 488515340344993323917400756787503527780909122454065787163751288532297676803107375385866015987133449103981488927270976699062805987617863144700011815391678529413502794773413320936327447220259453208979468730705087037372158854880384467715781160177138614969603045726997922071047500857340806069189158709215635242729553585563761095095693642463816510619482785576960370694079609031048841621266899403927593436588462868421606761514858887598967480638609582457970361111211772638047117931968397256718682318361446640249420151472348344475234992860568605515848173388433164886037247789277494331767915462657449349925652212607570624493475211996671539655630847952482082931169256673959722447906961137772769106520675213624107997020491140401081707013651452805784438912008371871292005235039393625546182172005376371830433584508857295200550745364042746584890082987140571777579583760220247338475203256004042686084234963990844108097426666122749212726977199804886411777903635953200887595772956134015363575902106063850623363111056377991700008363975884987285249916838232464233798661021425142104449949071867884145860557276445771208024856598823165127864476768837421434282022073239908948629169608868277543003648167347477692699052812109574298965145832053856742279399752), (244257670172496661958700378393751763890454561227032893581875644266148838401553687692933007993566724551990744463635488349531402993808931572350005907695839264706751397386706660468163723610129726604489734365352543518686079427440192233857890580088569307484801522863498961035523750428670403034594579354607817621364776792781880547547846821231908255309741392788480185347039804515524420810633449701963796718294231434210803380757429443799483740319304791228985180555605886319023558965984198628359341159180723320124710075736174172237617496430284302757924086694216582443018623894638747165883957731328724674962826106303785312246715421855052134640864848275315315525974554528025408602010859490529420909639488786857752699091008376406295145406585048180743091781052833575691213494335022898349787290655189683455058276777039813967974856714670231094566106349988106948769337852269265271250844792501452489821333555911564412310784198205326484131392436668305611348796538691801549701227542437991656908469237378885282002990225486799674977398203634249759798622751828665047129269204673856462445058765255906462566514942197514789454642487668313080016040733875753106054510283654788821815836005746156602983132359665929093643334886596824465440539880037812773610993916, 110394742952270067128812043127153415608740732466613144337934752679317402130606294313011615972978975946793215815156605543468481398050546367394723823260561013595405331284230140941100009313179087260931408474056794179078366476692502520015873181092200580444698822894473530689563538525178837874803952870753392943928643200388627744589049645667113685492065609199953706142930099284941983948021799467898973271080548391148570094812673730046146194730131980727139846057658545243663085962645746692509540488980413448711433096605915417183047988720676248814039439920662072158189671554443773059157166120874946192024753673489478718704245146545146174915388882810558975226741713323813653735066488705085194159906420390869498397222015274798990368735706607551138447906523358896389092442468505701851394573590549991529034703694177956102163273744726724095691653394163316905861539404977306640195887172307851967435950042804860259109949197124354567543808863439898289747924812360168052486045394058696049890809805449286492023500409278946155562039843615232588166175758051970156775267170392346538875259341043638354493663006001824799306750086167678996828927467915678981943255911507040852909251967552382228120818235365134482959651917714063407751396583131123610059825173)) #paillier.generate_keypair()
candidats = 0

client.connect(('localhost', 12345))
search = ""
responses = queue.Queue()
listen_thread = threading.Thread(target=listen, daemon=True)
listen_thread.start()


def read():
	global search
	global recu
	rt = "E"
	while(not responses.empty()):
		message = responses.get_nowait()
		mots = message.upper().split()
		print("debug " + str(mots) + " " + search)
		if mots[0] == "RETURN":
			if mots[2] == search:
				if mots[1] == "CODE":
					rt = mots[3]
				elif mots[1] == "INT8":
					rt = int(mots[3])
				elif mots[1] == "CHAR":
					if mots[2] == "GET_CANDIDATS":
						candidats = mots[3].split('/')
						rt = candidats
					rt = mots[3]
		elif mots[0] == "SEND_KEY":
			cle_serv = mots[1]
			print(cle_serv)
			send("SEND_KEY "+str(cle_public))
			search = mots[0]
		elif mots[0] == "SEND_KEY_PAILLIER":
			send("SEND_KEY_PAILLIER " + str(cle_paillier[0][0]) + " " + str(cle_paillier[0][1]))
			search=mots[0]
		elif mots[0] == "SEND_KEY_PROOF":
			send("SEND_KEY_PROOF " + str(int(mots[1])+1))
			search = mots[0]
	return rt

def login(nom, mdp):
	global search
	msg = "LOGIN " + nom + " " + mdp
	send(msg)
	search = "LOGIN"

def disconnect():
	print("client fermer")
	client.close()

def get_candidats():
	global search
	send("GET_CANDIDATS")
	search = "GET_CANDIDATS"

def vote(vote):
	global search
	msg = "VOTE"
	for loop in range(len(candidats)):
		if candidats[loop] == vote:
			msg+='1'
		else:
			msg += '0'
	send(msg)
	search="VOTE"

